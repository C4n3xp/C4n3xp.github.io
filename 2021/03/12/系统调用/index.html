<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Syscall快速系统调用借助MSR寄存器实现   IA32_LSTAR中存放着syscall时进入的系统入口地址nt!KiSystemCall64Shadow 12345678910115: kd&gt; rdmsr c0000082msr[c0000082] &#x3D; fffff800&#96;03fdfbc05: kd&gt; u fffff800&#96;03fdfbc0nt!KiSystemCall64Sha">
<meta property="og:type" content="article">
<meta property="og:title" content="系统调用">
<meta property="og:url" content="http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/index.html">
<meta property="og:site_name" content="sh1xo&#39;s Blog">
<meta property="og:description" content="Syscall快速系统调用借助MSR寄存器实现   IA32_LSTAR中存放着syscall时进入的系统入口地址nt!KiSystemCall64Shadow 12345678910115: kd&gt; rdmsr c0000082msr[c0000082] &#x3D; fffff800&#96;03fdfbc05: kd&gt; u fffff800&#96;03fdfbc0nt!KiSystemCall64Sha">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/C4n3xp/C4n3xp.github.io/blob/master/images/MSR.png?raw=true">
<meta property="og:image" content="https://github.com/C4n3xp/C4n3xp.github.io/blob/master/images/MSR%E6%A0%BC%E5%BC%8F.png?raw=true">
<meta property="article:published_time" content="2021-03-12T04:56:15.000Z">
<meta property="article:modified_time" content="2022-04-10T05:21:18.368Z">
<meta property="article:author" content="sh1xo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/C4n3xp/C4n3xp.github.io/blob/master/images/MSR.png?raw=true">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>系统调用</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">

    
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

    
<link rel="stylesheet" href="/css/style.css">

    <!-- rss -->
    
    
    <!-- jquery -->
    
<script src="/lib/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.1.0"></head>

<body>
    <div class="banner">
<div id="blogtitel" class="blogtitel">sh1xo&#39;s Blog</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    <div class="background">
      
        <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2022/03/15/APC%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/2021/03/10/%E5%8F%A5%E6%9F%84%E8%A1%A8/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&text=系统调用"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&title=系统调用"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&is_video=false&description=系统调用"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=系统调用&body=Check out this article: http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&title=系统调用"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&title=系统调用"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&title=系统调用"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&title=系统调用"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&name=系统调用&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Syscall"><span class="toc-number">1.</span> <span class="toc-text">Syscall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KiSystemCall64Shadow"><span class="toc-number">2.</span> <span class="toc-text">KiSystemCall64Shadow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KiSystemServiceExit"><span class="toc-number">3.</span> <span class="toc-text">KiSystemServiceExit</span></a></li></ol>
    </div>
  </span>
</div>

      
      <div class="content index width mx-auto px2 my4">
          
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        系统调用
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">sh1xo's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2021-03-12T04:56:15.000Z" itemprop="datePublished">2021-03-12</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Syscall"><a href="#Syscall" class="headerlink" title="Syscall"></a>Syscall</h2><p>快速系统调用借助MSR寄存器实现</p>
<p><img src="https://github.com/C4n3xp/C4n3xp.github.io/blob/master/images/MSR.png?raw=true"></p>
<p><img src="https://github.com/C4n3xp/C4n3xp.github.io/blob/master/images/MSR%E6%A0%BC%E5%BC%8F.png?raw=true"></p>
<p>IA32_LSTAR中存放着syscall时进入的系统入口地址nt!KiSystemCall64Shadow</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">5: kd&gt; rdmsr c0000082</span><br><span class="line">msr[c0000082] = fffff800`03fdfbc0</span><br><span class="line">5: kd&gt; u fffff800`03fdfbc0</span><br><span class="line">nt!KiSystemCall64Shadow:</span><br><span class="line">fffff800`03fdfbc0 0f01f8          swapgs</span><br><span class="line">fffff800`03fdfbc3 654889242510600000 mov   qword ptr gs:[6010h],rsp</span><br><span class="line">fffff800`03fdfbcc 65488b242500600000 mov   rsp,qword ptr gs:[6000h]</span><br><span class="line">fffff800`03fdfbd5 650fba24251860000001 bt  dword ptr gs:[6018h],1</span><br><span class="line">fffff800`03fdfbdf 7203            jb      nt!KiSystemCall64Shadow+0x24 (fffff800`03fdfbe4)</span><br><span class="line">fffff800`03fdfbe1 0f22dc          mov     cr3,rsp</span><br><span class="line">fffff800`03fdfbe4 65488b242508600000 mov   rsp,qword ptr gs:[6008h]</span><br></pre></td></tr></table></figure>

<p>IA32_STAR中存放着的syscall时要切换的CS段选择子和sysret返回时的CS段选择子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">5: kd&gt; rdmsr c0000081</span><br><span class="line">msr[c0000081] = 00230010`00000000</span><br><span class="line">5: kd&gt; dg 23</span><br><span class="line">                                                    P Si Gr Pr Lo</span><br><span class="line">Sel        Base              Limit          Type    l ze an es ng Flags</span><br><span class="line">---- ----------------- ----------------- ---------- - -- -- -- -- --------</span><br><span class="line">0023 00000000`00000000 00000000`ffffffff Code RE Ac 3 Bg Pg P  Nl 00000cfb</span><br><span class="line">5: kd&gt; dg 10</span><br><span class="line">                                                    P Si Gr Pr Lo</span><br><span class="line">Sel        Base              Limit          Type    l ze an es ng Flags</span><br><span class="line">---- ----------------- ----------------- ---------- - -- -- -- -- --------</span><br><span class="line">0010 00000000`00000000 00000000`00000000 Code RE Ac 0 Nb By P  Lo 0000029b</span><br></pre></td></tr></table></figure>

<p>IA32_FMASK中存放着syscall时要切换的EFLAGS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">5: kd&gt; rdmsr c0000084</span><br><span class="line">msr[c0000084] = 00000000`00004700</span><br></pre></td></tr></table></figure>

<p>syscall伪代码如下</p>
<p>值的注意的是，返回地址保持在了rcx中，CS段寄存器的值都是固定设置的，而且未发生堆栈切换，得留到R0层执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">IF (CS.L ≠ 1 ) or (IA32_EFER.LMA ≠ 1) or (IA32_EFER.SCE ≠ 1)</span><br><span class="line">(* Not in 64-Bit Mode or SYSCALL/SYSRET not enabled in IA32_EFER *)</span><br><span class="line">THEN #UD;</span><br><span class="line">FI;</span><br><span class="line">RCX ← RIP; (* Will contain address of next instruction *)</span><br><span class="line">RIP ← IA32_LSTAR;</span><br><span class="line">R11 ← RFLAGS;</span><br><span class="line">RFLAGS ← RFLAGS AND NOT(IA32_FMASK);</span><br><span class="line">CS.Selector ← IA32_STAR[47:32] AND FFFCH (* Operating system provides CS; RPL forced to 0 *)</span><br><span class="line">(* Set rest of CS to a fixed value *)</span><br><span class="line">CS.Base ← 0; (* Flat segment *)</span><br><span class="line">CS.Limit ← FFFFFH; (* With 4-KByte granularity, implies a 4-GByte limit *)</span><br><span class="line">CS.Type ← 11; (* Execute/read code, accessed *)</span><br><span class="line">CS.S ← 1;</span><br><span class="line">CS.DPL ← 0;</span><br><span class="line">CS.P ← 1;</span><br><span class="line">CS.L ← 1; (* Entry is to 64-bit mode *)</span><br><span class="line">CS.D ← 0; (* Required if CS.L = 1 *)</span><br><span class="line">CS.G ← 1; (* 4-KByte granularity *)</span><br><span class="line">CPL ← 0;</span><br></pre></td></tr></table></figure>

<p>查看ntdll中的系统调用，mov r10,rcx是为了保存原来的rcx值，为之后syscall将返回地址保存在rcx中腾出位置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000078</span>EB9AD0 ; NTSTATUS __stdcall <span class="title function_">NtOpenFile</span><span class="params">(PHANDLE FileHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PIO_STATUS_BLOCK IoStatusBlock, ULONG ShareAccess, ULONG OpenOptions)</span></span><br><span class="line">.text:0000000078EB9AD0                 public NtOpenFile</span><br><span class="line">.text:0000000078EB9AD0 NtOpenFile      proc near               ; CODE XREF: RtlpCreateNewDirectoryReference+A5↑p</span><br><span class="line">.text:<span class="number">0000000078</span>EB9AD0                                         ; RtlpResolveAssemblyStorageMapEntry+<span class="number">249</span>↑p ...</span><br><span class="line">.text:<span class="number">0000000078</span>EB9AD0                 mov     r10, rcx        ; NtOpenFile</span><br><span class="line">.text:<span class="number">0000000078</span>EB9AD3                 mov     eax, <span class="number">30</span>h ; <span class="string">&#x27;0&#x27;</span></span><br><span class="line">.text:<span class="number">0000000078</span>EB9AD8                 syscall                 ; Low latency system call</span><br><span class="line">.text:<span class="number">0000000078</span>EB9ADA                 retn</span><br><span class="line">.text:<span class="number">0000000078</span>EB9ADA NtOpenFile      endp</span><br></pre></td></tr></table></figure>

<p>相对的sysret伪代码如下</p>
<p>sysret前，操作系统会将返回地址设置在rcx中，这样执行完sysret后，rip即指向了syscall后的返回地址，接下来CS和SS的值也是固定设置的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">IF (CS.L ≠ 1 ) or (IA32_EFER.LMA ≠ 1) or (IA32_EFER.SCE ≠ 1)</span><br><span class="line">(* Not in 64-Bit Mode or SYSCALL/SYSRET not enabled in IA32_EFER *)</span><br><span class="line">THEN #UD; FI;</span><br><span class="line">IF (CPL ≠ 0) THEN #GP(0); FI;</span><br><span class="line">IF (operand size is 64-bit)</span><br><span class="line">THEN (* Return to 64-Bit Mode *)</span><br><span class="line">IF (RCX is not canonical) THEN #GP(0);</span><br><span class="line">RIP ← RCX;</span><br><span class="line">ELSE (* Return to Compatibility Mode *)</span><br><span class="line">RIP ← ECX;</span><br><span class="line">FI;</span><br><span class="line">RFLAGS ← (R11 &amp; 3C7FD7H) | 2; (* Clear RF, VM, reserved bits; set bit 2 *)</span><br><span class="line">IF (operand size is 64-bit)</span><br><span class="line">THEN CS.Selector ← IA32_STAR[63:48]+16;</span><br><span class="line">ELSE CS.Selector ← IA32_STAR[63:48];</span><br><span class="line">FI;</span><br><span class="line">CS.Selector ← CS.Selector OR 3; (* RPL forced to 3 *)</span><br><span class="line">(* Set rest of CS to a fixed value *)</span><br><span class="line">CS.Base ← 0; (* Flat segment *)</span><br><span class="line">CS.Limit ← FFFFFH; (* With 4-KByte granularity, implies a 4-GByte limit *)</span><br><span class="line">CS.Type ← 11; (* Execute/read code, accessed *)</span><br><span class="line">CS.S ← 1;</span><br><span class="line">CS.DPL ← 3;</span><br><span class="line">CS.P ← 1;</span><br><span class="line">IF (operand size is 64-bit)</span><br><span class="line">THEN (* Return to 64-Bit Mode *)</span><br><span class="line">CS.L ← 1; (* 64-bit code segment *)</span><br><span class="line">CS.D ← 0; (* Required if CS.L = 1 *)</span><br><span class="line">ELSE (* Return to Compatibility Mode *)</span><br><span class="line">CS.L ← 0; (* Compatibility mode *)</span><br><span class="line">CS.D ← 1; (* 32-bit code segment *)</span><br><span class="line">FI;</span><br><span class="line">CS.G ← 1; (* 4-KByte granularity *)</span><br><span class="line">CPL ← 3;</span><br><span class="line">SS.Selector ← (IA32_STAR[63:48]+8) OR 3; (* RPL forced to 3 *)</span><br><span class="line">(* Set rest of SS to a fixed value *)</span><br><span class="line">SS.Base ← 0; (* Flat segment *)</span><br><span class="line">SS.Limit ← FFFFFH; (* With 4-KByte granularity, implies a 4-GByte limit *)</span><br><span class="line">SS.Type ← 3; (* Read/write data, accessed *)</span><br><span class="line">SS.S ← 1;</span><br><span class="line">SS.DPL ← 3;</span><br><span class="line">SS.P ← 1;</span><br><span class="line">SS.B ← 1; (* 32-bit stack segment*)</span><br><span class="line">SS.G ← 1; (* 4-KByte granularity *)</span><br></pre></td></tr></table></figure>

<h2 id="KiSystemCall64Shadow"><a href="#KiSystemCall64Shadow" class="headerlink" title="KiSystemCall64Shadow"></a>KiSystemCall64Shadow</h2><p>(win7 64位 7601)</p>
<p>执行完syscall，设置eip，切换cs后变来到了r0环境执行</p>
<p>开头先swapgs，切换gs指向kpcr</p>
<p>然后保存r3的rsp到kpcr.prcb.UserRspShadow</p>
<p>检测kpcr.prcb.ShadowFlags的低第1位，置位的则将kpcr.prcb.KernelDirectoryTableBase赋值给cr3</p>
<p>切换rsp到kpcr.prcb.RspBaseShadow</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">KVASCODE:00000001401D2BC0                 swapgs</span><br><span class="line">KVASCODE:00000001401D2BC3                 mov     gs:6010h, rsp</span><br><span class="line">KVASCODE:00000001401D2BCC                 mov     rsp, gs:6000h</span><br><span class="line">KVASCODE:00000001401D2BD5                 bt      dword ptr gs:6018h, 1</span><br><span class="line">KVASCODE:00000001401D2BDF                 jb      short loc_1401D2BE4</span><br><span class="line">KVASCODE:00000001401D2BE1                 mov     cr3, rsp </span><br><span class="line">KVASCODE:00000001401D2BE4 loc_1401D2BE4:                          ; CODE XREF: KiSystemCall64Shadow+1F↑j</span><br><span class="line">KVASCODE:00000001401D2BE4                 mov     rsp, gs:6008h</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">``</span><br><span class="line">5: kd&gt; dt _kpcr</span><br><span class="line">ntdll!_KPCR</span><br><span class="line">   +0x000 NtTib            : _NT_TIB</span><br><span class="line">   +0x000 GdtBase          : Ptr64 _KGDTENTRY64</span><br><span class="line">   +0x008 TssBase          : Ptr64 _KTSS64</span><br><span class="line">   +0x010 UserRsp          : Uint8B</span><br><span class="line">   +0x018 Self             : Ptr64 _KPCR</span><br><span class="line">   +0x020 CurrentPrcb      : Ptr64 _KPRCB</span><br><span class="line">   +0x028 LockArray        : Ptr64 _KSPIN_LOCK_QUEUE</span><br><span class="line">   +0x030 Used_Self        : Ptr64 Void</span><br><span class="line">   +0x038 IdtBase          : Ptr64 _KIDTENTRY64</span><br><span class="line">   +0x040 Unused           : [2] Uint8B</span><br><span class="line">   +0x050 Irql             : UChar</span><br><span class="line">   +0x051 SecondLevelCacheAssociativity : UChar</span><br><span class="line">   +0x052 ObsoleteNumber   : UChar</span><br><span class="line">   +0x053 Fill0            : UChar</span><br><span class="line">   +0x054 Unused0          : [3] Uint4B</span><br><span class="line">   +0x060 MajorVersion     : Uint2B</span><br><span class="line">   +0x062 MinorVersion     : Uint2B</span><br><span class="line">   +0x064 StallScaleFactor : Uint4B</span><br><span class="line">   +0x068 Unused1          : [3] Ptr64 Void</span><br><span class="line">   +0x080 KernelReserved   : [15] Uint4B</span><br><span class="line">   +0x0bc SecondLevelCacheSize : Uint4B</span><br><span class="line">   +0x0c0 HalReserved      : [16] Uint4B</span><br><span class="line">   +0x100 Unused2          : Uint4B</span><br><span class="line">   +0x108 KdVersionBlock   : Ptr64 Void</span><br><span class="line">   +0x110 Unused3          : Ptr64 Void</span><br><span class="line">   +0x118 PcrAlign1        : [24] Uint4B</span><br><span class="line">   +0x180 Prcb             : _KPRCB</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">5: kd&gt; dt _KPRCB</span><br><span class="line">ntdll!_KPRCB</span><br><span class="line">   +0x000 MxCsr            : Uint4B</span><br><span class="line">   +0x004 LegacyNumber     : UChar</span><br><span class="line">   +0x005 ReservedMustBeZero : UChar</span><br><span class="line">   +0x006 InterruptRequest : UChar</span><br><span class="line">   +0x007 IdleHalt         : UChar</span><br><span class="line">   +0x008 CurrentThread    : Ptr64 _KTHREAD</span><br><span class="line">   +0x010 NextThread       : Ptr64 _KTHREAD</span><br><span class="line">   +0x018 IdleThread       : Ptr64 _KTHREAD</span><br><span class="line">   +0x020 NestingLevel     : UChar</span><br><span class="line">   +0x021 PrcbPad00        : [3] UChar</span><br><span class="line">   +0x024 Number           : Uint4B</span><br><span class="line">   +0x028 RspBase          : Uint8B</span><br><span class="line">   +0x030 PrcbLock         : Uint8B</span><br><span class="line">   +0x038 PrcbPad01        : Uint8B</span><br><span class="line">   +0x040 ProcessorState   : _KPROCESSOR_STATE        </span><br><span class="line">   ...</span><br><span class="line">   ...</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>接着将r3的 ss&#x3D;0x2b, rsp, r11&#x3D;Eflags, cs&#x3D;0x33, rcx&#x3D;返回地址 依次压入栈中，填充KTRAP_FRAME结构</p>
<p>将syscall前保存在r10中的rcx值复原</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">KVASCODE:00000001401D2BED</span><br><span class="line">KVASCODE:00000001401D2BED KiSystemCall64ShadowCommon:</span><br><span class="line">KVASCODE:00000001401D2BED                 push    2Bh ; &#x27;+&#x27;</span><br><span class="line">KVASCODE:00000001401D2BEF                 push    qword ptr gs:6010h</span><br><span class="line">KVASCODE:00000001401D2BF7                 push    r11</span><br><span class="line">KVASCODE:00000001401D2BF9                 push    33h ; &#x27;3&#x27;</span><br><span class="line">KVASCODE:00000001401D2BFB                 push    rcx</span><br><span class="line">KVASCODE:00000001401D2BFC                 mov     rcx, r10</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">5: kd&gt; dt _KTRAP_FRAME</span><br><span class="line">ntdll!_KTRAP_FRAME</span><br><span class="line">   +0x000 P1Home           : Uint8B</span><br><span class="line">   +0x008 P2Home           : Uint8B</span><br><span class="line">   +0x010 P3Home           : Uint8B</span><br><span class="line">   +0x018 P4Home           : Uint8B</span><br><span class="line">   +0x020 P5               : Uint8B</span><br><span class="line">   +0x028 PreviousMode     : Char</span><br><span class="line">   +0x029 PreviousIrql     : UChar</span><br><span class="line">   +0x02a FaultIndicator   : UChar</span><br><span class="line">   +0x02a NmiMsrIbrs       : UChar</span><br><span class="line">   +0x02b ExceptionActive  : UChar</span><br><span class="line">   +0x02c MxCsr            : Uint4B</span><br><span class="line">   +0x030 Rax              : Uint8B</span><br><span class="line">   +0x038 Rcx              : Uint8B</span><br><span class="line">   +0x040 Rdx              : Uint8B</span><br><span class="line">   +0x048 R8               : Uint8B</span><br><span class="line">   +0x050 R9               : Uint8B</span><br><span class="line">   +0x058 R10              : Uint8B</span><br><span class="line">   +0x060 R11              : Uint8B</span><br><span class="line">   +0x068 GsBase           : Uint8B</span><br><span class="line">   +0x068 GsSwap           : Uint8B</span><br><span class="line">   +0x070 Xmm0             : _M128A</span><br><span class="line">   +0x080 Xmm1             : _M128A</span><br><span class="line">   +0x090 Xmm2             : _M128A</span><br><span class="line">   +0x0a0 Xmm3             : _M128A</span><br><span class="line">   +0x0b0 Xmm4             : _M128A</span><br><span class="line">   +0x0c0 Xmm5             : _M128A</span><br><span class="line">   +0x0d0 FaultAddress     : Uint8B</span><br><span class="line">   +0x0d0 ContextRecord    : Uint8B</span><br><span class="line">   +0x0d0 TimeStampCKCL    : Uint8B</span><br><span class="line">   +0x0d8 Dr0              : Uint8B</span><br><span class="line">   +0x0e0 Dr1              : Uint8B</span><br><span class="line">   +0x0e8 Dr2              : Uint8B</span><br><span class="line">   +0x0f0 Dr3              : Uint8B</span><br><span class="line">   +0x0f8 Dr6              : Uint8B</span><br><span class="line">   +0x100 Dr7              : Uint8B</span><br><span class="line">   +0x108 DebugControl     : Uint8B</span><br><span class="line">   +0x110 LastBranchToRip  : Uint8B</span><br><span class="line">   +0x118 LastBranchFromRip : Uint8B</span><br><span class="line">   +0x120 LastExceptionToRip : Uint8B</span><br><span class="line">   +0x128 LastExceptionFromRip : Uint8B</span><br><span class="line">   +0x130 SegDs            : Uint2B</span><br><span class="line">   +0x132 SegEs            : Uint2B</span><br><span class="line">   +0x134 SegFs            : Uint2B</span><br><span class="line">   +0x136 SegGs            : Uint2B</span><br><span class="line">   +0x138 TrapFrame        : Uint8B</span><br><span class="line">   +0x140 Rbx              : Uint8B</span><br><span class="line">   +0x148 Rdi              : Uint8B</span><br><span class="line">   +0x150 Rsi              : Uint8B</span><br><span class="line">   +0x158 Rbp              : Uint8B</span><br><span class="line">   +0x160 ErrorCode        : Uint8B</span><br><span class="line">   +0x160 ExceptionFrame   : Uint8B</span><br><span class="line">   +0x160 TimeStampKlog    : Uint8B</span><br><span class="line">   +0x168 Rip              : Uint8B</span><br><span class="line">   +0x170 SegCs            : Uint2B</span><br><span class="line">   +0x172 Fill0            : UChar</span><br><span class="line">   +0x173 Logging          : UChar</span><br><span class="line">   +0x174 Fill1            : [2] Uint2B</span><br><span class="line">   +0x178 EFlags           : Uint4B</span><br><span class="line">   +0x17c Fill2            : Uint4B</span><br><span class="line">   +0x180 Rsp              : Uint8B</span><br><span class="line">   +0x188 SegSs            : Uint2B</span><br><span class="line">   +0x18a Fill3            : Uint2B</span><br><span class="line">   +0x18c CodePatchCycle   : Int4B</span><br></pre></td></tr></table></figure>

<p>接下去继续填充KTRAP_FRAME结构，随后跳到KiSystemServiceUser</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">KVASCODE:00000001401D2BFF                 sub     rsp, 8          ; 跳过ErrorCode</span><br><span class="line">KVASCODE:00000001401D2C03                 push    rbp             ; 压入rbp</span><br><span class="line">KVASCODE:00000001401D2C04                 sub     rsp, 158h       ; rsp指向KTRAP_FRAME起始地址</span><br><span class="line">KVASCODE:00000001401D2C0B                 lea     rbp, [rsp+190h+var_110] ; rbp=KTRAP_FRAME+80h</span><br><span class="line">KVASCODE:00000001401D2C13                 mov     [rbp+0C0h], rbx</span><br><span class="line">KVASCODE:00000001401D2C1A                 mov     [rbp+0C8h], rdi</span><br><span class="line">KVASCODE:00000001401D2C21                 mov     [rbp+0D0h], rsi</span><br><span class="line">KVASCODE:00000001401D2C28                 jmp     short loc_1401D2C66</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">KVASCODE:00000001401D2C66 loc_1401D2C66:                          ; CODE XREF: KiSystemCall64Shadow+68↑j</span><br><span class="line">KVASCODE:00000001401D2C66                 mov     [rbp-50h], rax</span><br><span class="line">KVASCODE:00000001401D2C6A                 mov     [rbp-48h], rcx</span><br><span class="line">KVASCODE:00000001401D2C6E                 mov     [rbp-40h], rdx</span><br><span class="line">KVASCODE:00000001401D2C72                 mov     rcx, gs:188h    ; rcx=CurrentThread</span><br><span class="line">KVASCODE:00000001401D2C7B                 mov     rcx, [rcx+210h] ; rcx=CurrentProcess</span><br><span class="line">KVASCODE:00000001401D2C82                 mov     rcx, [rcx+4E8h]</span><br><span class="line">KVASCODE:00000001401D2C89                 mov     gs:2370h, rcx</span><br><span class="line">KVASCODE:00000001401D2C92                 movzx   eax, byte ptr gs:237Bh</span><br><span class="line">KVASCODE:00000001401D2C9B                 cmp     gs:237Ah, al</span><br><span class="line">KVASCODE:00000001401D2CA3                 jz      short loc_1401D2CB6</span><br><span class="line">KVASCODE:00000001401D2CA5                 mov     gs:237Ah, al</span><br><span class="line">KVASCODE:00000001401D2CAD                 mov     ecx, 48h ; &#x27;H&#x27;</span><br><span class="line">KVASCODE:00000001401D2CB2                 xor     edx, edx</span><br><span class="line">KVASCODE:00000001401D2CB4                 wrmsr</span><br><span class="line">KVASCODE:00000001401D2CB6</span><br><span class="line">KVASCODE:00000001401D2CB6 loc_1401D2CB6:                          ; CODE XREF: KiSystemCall64Shadow+E3↑j</span><br><span class="line">KVASCODE:00000001401D2CB6                 movzx   edx, byte ptr gs:2378h</span><br><span class="line">KVASCODE:00000001401D2CBF                 test    edx, 8</span><br><span class="line">KVASCODE:00000001401D2CC5                 jz      short loc_1401D2CDA</span><br><span class="line">KVASCODE:00000001401D2CC7                 mov     eax, 1</span><br><span class="line">KVASCODE:00000001401D2CCC                 xor     edx, edx</span><br><span class="line">KVASCODE:00000001401D2CCE                 mov     ecx, 49h ; &#x27;I&#x27;</span><br><span class="line">KVASCODE:00000001401D2CD3                 wrmsr</span><br><span class="line">KVASCODE:00000001401D2CD5                 jmp     loc_1401D2E18   ;前面一段不关注</span><br></pre></td></tr></table></figure>

<p>首先进行调试环境的一些检测</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.text:00000001400A1D02                 mov     byte ptr [rbp-55h], 2 ; KTRAP_FRAME.ExceptionActive=2</span><br><span class="line">.text:00000001400A1D06                 mov     rbx, gs:188h    ; rbx=CurrentThread</span><br><span class="line">.text:00000001400A1D0F                 prefetchw byte ptr [rbx+1D8h]</span><br><span class="line">.text:00000001400A1D16                 stmxcsr dword ptr [rbp-54h]</span><br><span class="line">.text:00000001400A1D1A                 ldmxcsr dword ptr gs:180h</span><br><span class="line">.text:00000001400A1D23                 cmp     byte ptr [rbx+3], 0 ; cmp CurrentThread.DebugActive,0</span><br><span class="line">.text:00000001400A1D27                 mov     word ptr [rbp+80h], 0 ; KTRAP_FRAME.Dr7=0</span><br><span class="line">.text:00000001400A1D30                 jz      loc_1400A1DB7   ; no debug,跳</span><br><span class="line">.text:00000001400A1D36                 test    byte ptr [rbx+3], 3</span><br><span class="line">.text:00000001400A1D3A                 mov     [rbp-38h], r8</span><br><span class="line">.text:00000001400A1D3E                 mov     [rbp-30h], r9</span><br><span class="line">.text:00000001400A1D42                 jz      short loc_1400A1D49</span><br><span class="line">.text:00000001400A1D44                 call    KiSaveDebugRegisterState</span><br></pre></td></tr></table></figure>

<p>下面是ssdt表计算函数地址</p>
<p>最终函数地址&#x3D; ssdt[idx]&gt;&gt;4+ssdt基地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">.text:00000001400A1DB7 loc_1400A1DB7:                          ; CODE XREF: KiSystemCall64+230↑j</span><br><span class="line">.text:00000001400A1DB7                 mov     rax, [rbp-50h]  ; 取出保存的寄存器值</span><br><span class="line">.text:00000001400A1DBB                 mov     rcx, [rbp-48h]</span><br><span class="line">.text:00000001400A1DBF                 mov     rdx, [rbp-40h]</span><br><span class="line">.text:00000001400A1DC3                 db      66h, 66h, 66h, 66h</span><br><span class="line">.text:00000001400A1DC3                 nop     word ptr [rax+rax+00000000h]</span><br><span class="line">.text:00000001400A1DD0                 sti                     ; 恢复中断</span><br><span class="line">.text:00000001400A1DD1                 mov     [rbx+1E0h], rcx ; CurrentThread.FirstArgument=rcx</span><br><span class="line">.text:00000001400A1DD8                 mov     [rbx+1F8h], eax ; CurrentThread.SystemCallNumber=eax</span><br><span class="line">.text:00000001400A1DDE</span><br><span class="line">.text:00000001400A1DDE KiSystemServiceStart:                   ; DATA XREF: KiServiceInternal+5A↑o</span><br><span class="line">.text:00000001400A1DDE                                         ; .data:00000001401DF838↓o</span><br><span class="line">.text:00000001400A1DDE                 mov     [rbx+1D8h], rsp ; CurrentThread.TrapFrame=rsp</span><br><span class="line">.text:00000001400A1DE5                 mov     edi, eax</span><br><span class="line">.text:00000001400A1DE7                 shr     edi, 7</span><br><span class="line">.text:00000001400A1DEA                 and     edi, 20h        ; (系统调用号&gt;&gt;7)&amp;20h，即判断是否是Shadow表API</span><br><span class="line">.text:00000001400A1DEA                                         ; edi=0或0x20</span><br><span class="line">.text:00000001400A1DED                 and     eax, 0FFFh      ; 取系统调用号低12位</span><br><span class="line">.text:00000001400A1DF2</span><br><span class="line">.text:00000001400A1DF2 KiSystemServiceRepeat:                  ; CODE XREF: KiSystemCall64+68F↓j</span><br><span class="line">.text:00000001400A1DF2                 lea     r10, KeServiceDescriptorTable</span><br><span class="line">.text:00000001400A1DF9                 lea     r11, KeServiceDescriptorTableShadow</span><br><span class="line">.text:00000001400A1E00                 test    dword ptr [rbx+100h], 80h ; 测试CurrentThread.GuiThread是否置位</span><br><span class="line">.text:00000001400A1E0A                 cmovnz  r10, r11</span><br><span class="line">.text:00000001400A1E0E                 cmp     eax, [rdi+r10+10h] ; 判断系统调用号是否越界</span><br><span class="line">.text:00000001400A1E13                 jnb     loc_1400A2156   ; 越界 1.传入序号有错 2.还没有转换成gui线程就调用了shadowSSDT的函数</span><br><span class="line">.text:00000001400A1E19                 mov     r10, [rdi+r10]  ; rdi为0，则取ssdt，为0x20则取Shadow ssdt</span><br><span class="line">.text:00000001400A1E1D                 movsxd  r11, dword ptr [r10+rax*4] ; rax作为索引取ssdt内容</span><br><span class="line">.text:00000001400A1E21                 mov     rax, r11</span><br><span class="line">.text:00000001400A1E24                 sar     r11, 4          ; 算术右移4位</span><br><span class="line">.text:00000001400A1E28                 add     r10, r11        ; 加上ssdt基地址，即最终系统调用地址 </span><br><span class="line">.text:00000001400A1E2B                 cmp     edi, 20h ; &#x27; &#x27;</span><br><span class="line">.text:00000001400A1E2E                 jnz     short loc_1400A1E80 ; 不是Shadow ssdt则跳</span><br></pre></td></tr></table></figure>

<p>判断下是否还有剩余的参数需要复制到栈中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">.text:00000001400A1E80 loc_1400A1E80:                          ; CODE XREF: KiSystemCall64+32E↑j</span><br><span class="line">.text:00000001400A1E80                                         ; KiSystemCall64+33F↑j</span><br><span class="line">.text:00000001400A1E80                 and     eax, 0Fh        ; ssdt[idx]的低4字节用来表示除了rcx,rdx,r8,r9外需要的参数个数</span><br><span class="line">.text:00000001400A1E83                 jz      KiSystemServiceCopyEnd</span><br><span class="line">.text:00000001400A1E89                 shl     eax, 3          ;左移3，剩余参数个数乘8，即参数所占空间</span><br><span class="line">.text:00000001400A1E8C                 lea     rsp, [rsp-70h]  ;腾出空间</span><br><span class="line">.text:00000001400A1E91                 lea     rdi, [rsp+200h+var_1E8] </span><br><span class="line">.text:00000001400A1E96                 mov     rsi, [rbp+100h]  ;rsi=r3 rsp</span><br><span class="line">.text:00000001400A1E9D                 lea     rsi, [rsi+20h]   ;rsi=r3 栈中剩余参数起始地址</span><br><span class="line">.text:00000001400A1EA1                 test    byte ptr [rbp+0F0h], 1 ;判断是否是从r3来的系统调用，需要r3 rsp是否越界</span><br><span class="line">.text:00000001400A1EA8                 jz      short loc_1400A1EC0</span><br><span class="line">.text:00000001400A1EAA                 cmp     rsi, cs:MmUserProbeAddress</span><br><span class="line">.text:00000001400A1EB1                 cmovnb  rsi, cs:MmUserProbeAddress</span><br><span class="line">.text:00000001400A1EB9                 nop     dword ptr [rax+00000000h]</span><br><span class="line">.text:00000001400A1EC0</span><br><span class="line">.text:00000001400A1EC0 loc_1400A1EC0:                          ; CODE XREF: KiSystemCall64+3A8↑j</span><br><span class="line">.text:00000001400A1EC0                 lea     r11, KiSystemServiceCopyEnd</span><br><span class="line">.text:00000001400A1EC7                 sub     r11, rax  ;跳到下面复制参数</span><br><span class="line">.text:00000001400A1ECA                 jmp     r11</span><br><span class="line">.text:00000001400A1ECA ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000001400A1ECD                 align 10h</span><br><span class="line">.text:00000001400A1ED0</span><br><span class="line">.text:00000001400A1ED0 KiSystemServiceCopyStart:               ; DATA XREF: KiSystemServiceHandler+1A↑o</span><br><span class="line">.text:00000001400A1ED0                 mov     rax, [rsi+70h]</span><br><span class="line">.text:00000001400A1ED4                 mov     [rdi+70h], rax</span><br><span class="line">.text:00000001400A1ED8                 mov     rax, [rsi+68h]</span><br><span class="line">.text:00000001400A1EDC                 mov     [rdi+68h], rax</span><br><span class="line">.text:00000001400A1EE0                 mov     rax, [rsi+60h]</span><br><span class="line">.text:00000001400A1EE4                 mov     [rdi+60h], rax</span><br><span class="line">.text:00000001400A1EE8                 mov     rax, [rsi+58h]</span><br><span class="line">.text:00000001400A1EEC                 mov     [rdi+58h], rax</span><br><span class="line">.text:00000001400A1EF0                 mov     rax, [rsi+50h]</span><br><span class="line">.text:00000001400A1EF4                 mov     [rdi+50h], rax</span><br><span class="line">.text:00000001400A1EF8                 mov     rax, [rsi+48h]</span><br><span class="line">.text:00000001400A1EFC                 mov     [rdi+48h], rax</span><br><span class="line">.text:00000001400A1F00                 mov     rax, [rsi+40h]</span><br><span class="line">.text:00000001400A1F04                 mov     [rdi+40h], rax</span><br><span class="line">.text:00000001400A1F08                 mov     rax, [rsi+38h]</span><br><span class="line">.text:00000001400A1F0C                 mov     [rdi+38h], rax</span><br><span class="line">.text:00000001400A1F10                 mov     rax, [rsi+30h]</span><br><span class="line">.text:00000001400A1F14                 mov     [rdi+30h], rax</span><br><span class="line">.text:00000001400A1F18                 mov     rax, [rsi+28h]</span><br><span class="line">.text:00000001400A1F1C                 mov     [rdi+28h], rax</span><br><span class="line">.text:00000001400A1F20                 mov     rax, [rsi+20h]</span><br><span class="line">.text:00000001400A1F24                 mov     [rdi+20h], rax</span><br><span class="line">.text:00000001400A1F28                 mov     rax, [rsi+18h]</span><br><span class="line">.text:00000001400A1F2C                 mov     [rdi+18h], rax</span><br><span class="line">.text:00000001400A1F30                 mov     rax, [rsi+10h]</span><br><span class="line">.text:00000001400A1F34                 mov     [rdi+10h], rax</span><br><span class="line">.text:00000001400A1F38                 mov     rax, [rsi+8]</span><br><span class="line">.text:00000001400A1F3C                 mov     [rdi+8], rax</span><br><span class="line">.text:00000001400A1F40</span><br><span class="line">.text:00000001400A1F40 KiSystemServiceCopyEnd:                 ; CODE XREF: KiSystemCall64+383↑j</span><br><span class="line">.text:00000001400A1F40                                         ; DATA XREF: KiSystemServiceHandler+27↑o ...</span><br><span class="line">.text:00000001400A1F40                 test    cs:dword_1401FA848, 40h</span><br><span class="line">.text:00000001400A1F4A                 jnz     loc_1400A21F4</span><br><span class="line">.text:00000001400A1F50                 call    r10  ;调用最终系统调用</span><br></pre></td></tr></table></figure>

<h2 id="KiSystemServiceExit"><a href="#KiSystemServiceExit" class="headerlink" title="KiSystemServiceExit"></a>KiSystemServiceExit</h2><p>系统调用完成后，返回到KiSystemServiceExit</p>
<p>可以看到，如果是r3的调用，且当前线程的UserApcPending置位，则先进行用户层APC分发</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">text:00000001400A1F53 loc_1400A1F53:                          ; CODE XREF: KiSystemCall64+749↓j</span><br><span class="line">.text:00000001400A1F53                 inc     dword ptr gs:2238h ; kpcr.kprcb.KeSystemCalls+=1</span><br><span class="line">.text:00000001400A1F5B</span><br><span class="line">.text:00000001400A1F5B KiSystemServiceExit:                    ; CODE XREF: KiSystemCall64+6B0↓j</span><br><span class="line">.text:00000001400A1F5B                                         ; KiSystemCall64+6BB↓j</span><br><span class="line">.text:00000001400A1F5B                                         ; DATA XREF: ...</span><br><span class="line">.text:00000001400A1F5B                 mov     rbx, [rbp+0C0h]</span><br><span class="line">.text:00000001400A1F62                 mov     rdi, [rbp+0C8h]</span><br><span class="line">.text:00000001400A1F69                 mov     rsi, [rbp+0D0h]</span><br><span class="line">.text:00000001400A1F70                 mov     r11, gs:188h    ; r11=CurrentThread</span><br><span class="line">.text:00000001400A1F79                 test    byte ptr [rbp+0F0h], 1 ; 判断是否是r3调用</span><br><span class="line">.text:00000001400A1F80                 jz      loc_1400A2129   ; r0调用跳到返回</span><br><span class="line">.text:00000001400A1F86                 mov     rcx, cr8</span><br><span class="line">.text:00000001400A1F8A                 or      cl, [r11+1F0h]  ; or cl,thread.ApcStateIndex</span><br><span class="line">.text:00000001400A1F91                 or      ecx, [r11+1C4h] ; or,cl,thread.CombinedApcDisable</span><br><span class="line">.text:00000001400A1F98                 jnz     loc_1400A21C0</span><br><span class="line">.text:00000001400A1F9E                 cli                     ; 关中断</span><br><span class="line">.text:00000001400A1F9F                 mov     rcx, gs:188h    ; rcx=CurrentThread</span><br><span class="line">.text:00000001400A1FA8                 cmp     byte ptr [rcx+7Ah], 0 ; cmp,thread.UserApcPending,0</span><br><span class="line">.text:00000001400A1FAC                 jz      short loc_1400A2005 ; UserApcPending未置位，不进行用户层apc分发</span><br><span class="line">.text:00000001400A1FAE                 mov     [rbp-50h], rax</span><br><span class="line">.text:00000001400A1FB2                 xor     eax, eax</span><br><span class="line">.text:00000001400A1FB4                 mov     [rbp-48h], rax</span><br><span class="line">.text:00000001400A1FB8                 mov     [rbp-40h], rax</span><br><span class="line">.text:00000001400A1FBC                 mov     [rbp-38h], rax</span><br><span class="line">.text:00000001400A1FC0                 mov     [rbp-30h], rax</span><br><span class="line">.text:00000001400A1FC4                 mov     [rbp-28h], rax</span><br><span class="line">.text:00000001400A1FC8                 mov     [rbp-20h], rax</span><br><span class="line">.text:00000001400A1FCC                 pxor    xmm0, xmm0</span><br><span class="line">.text:00000001400A1FD0                 movaps  xmmword ptr [rbp-10h], xmm0</span><br><span class="line">.text:00000001400A1FD4                 movaps  xmmword ptr [rbp+0], xmm0</span><br><span class="line">.text:00000001400A1FD8                 movaps  xmmword ptr [rbp+10h], xmm0</span><br><span class="line">.text:00000001400A1FDC                 movaps  xmmword ptr [rbp+20h], xmm0</span><br><span class="line">.text:00000001400A1FE0                 movaps  xmmword ptr [rbp+30h], xmm0</span><br><span class="line">.text:00000001400A1FE4                 movaps  xmmword ptr [rbp+40h], xmm0</span><br><span class="line">.text:00000001400A1FE8                 mov     ecx, 1</span><br><span class="line">.text:00000001400A1FED                 mov     cr8, rcx        ; 将irql提升为apc级别</span><br><span class="line">.text:00000001400A1FF1                 sti                     ; 开中断</span><br><span class="line">.text:00000001400A1FF2                 call    KiInitiateUserApc ; 进行用户层APC分发(win7 中KiInitiateUserApc直接调用KiDeliverApc)</span><br><span class="line">.text:00000001400A1FF7                 cli</span><br><span class="line">.text:00000001400A1FF8                 mov     ecx, 0</span><br><span class="line">.text:00000001400A1FFD                 mov     cr8, rcx        ; 降低irql</span><br><span class="line">.text:00000001400A2001                 mov     rax, [rbp-50h]</span><br><span class="line">.text:00000001400A2005</span><br><span class="line">.text:00000001400A2005 loc_1400A2005:                          ; CODE XREF: KiSystemCall64+4AC↑j</span><br><span class="line">.text:00000001400A2005                 mov     rcx, gs:188h    ; ums相关</span><br><span class="line">.text:00000001400A200E                 test    dword ptr [rcx], 40020000h</span><br><span class="line">.text:00000001400A2014                 jz      short loc_1400A2044 ; 经调试，跳转</span><br></pre></td></tr></table></figure>

<p>判断cr7，是否要恢复调试寄存器</p>
<p>恢复r3的栈帧，系统调用返回值存放在rax中，sysret前将返回地址存放在rcx中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">.text:00000001400A2044 loc_1400A2044:                          ; CODE XREF: KiSystemCall64+514↑j</span><br><span class="line">.text:00000001400A2044                 ldmxcsr dword ptr [rbp-54h]</span><br><span class="line">.text:00000001400A2048                 xor     r10, r10</span><br><span class="line">.text:00000001400A204B                 cmp     word ptr [rbp+80h], 0 ; 判断dr7是否为0</span><br><span class="line">.text:00000001400A2053                 jz      short loc_1400A2093 ; 为0则不恢复调试寄存器，跳转</span><br><span class="line">.text:00000001400A2055                 mov     [rbp-50h], rax</span><br><span class="line">.text:00000001400A2059                 call    KiRestoreDebugRegisterState</span><br><span class="line">.text:00000001400A205E                 mov     rax, gs:188h</span><br><span class="line">.text:00000001400A2067                 mov     rax, [rax+70h]</span><br><span class="line">.text:00000001400A206B                 mov     rax, [rax+100h]</span><br><span class="line">.text:00000001400A2072                 or      rax, rax</span><br><span class="line">.text:00000001400A2075                 jz      short loc_1400A208F</span><br><span class="line">.text:00000001400A2077                 cmp     word ptr [rbp+0F0h], 33h ; &#x27;3&#x27;</span><br><span class="line">.text:00000001400A207F                 jnz     short loc_1400A208F</span><br><span class="line">.text:00000001400A2081                 mov     r10, [rbp+0E8h]</span><br><span class="line">.text:00000001400A2088                 mov     [rbp+0E8h], rax</span><br><span class="line">.text:00000001400A208F</span><br><span class="line">.text:00000001400A208F loc_1400A208F:                          ; CODE XREF: KiSystemCall64+575↑j</span><br><span class="line">.text:00000001400A208F                                         ; KiSystemCall64+57F↑j</span><br><span class="line">.text:00000001400A208F                 mov     rax, [rbp-50h]</span><br><span class="line">.text:00000001400A2093 loc_1400A2093:                          ; CODE XREF: KiSystemCall64+553↑j</span><br><span class="line">.text:00000001400A2093                 mov     [rbp-50h], rax  ; 不专注这些</span><br><span class="line">.text:00000001400A2097                 movzx   eax, byte ptr gs:237Dh</span><br><span class="line">.text:00000001400A20A0                 cmp     gs:237Ah, al</span><br><span class="line">.text:00000001400A20A8                 jz      short loc_1400A20BB</span><br><span class="line">.text:00000001400A20AA                 mov     gs:237Ah, al</span><br><span class="line">.text:00000001400A20B2                 mov     ecx, 48h ; &#x27;H&#x27;</span><br><span class="line">.text:00000001400A20B7                 xor     edx, edx</span><br><span class="line">.text:00000001400A20B9                 wrmsr</span><br><span class="line">.text:00000001400A20BB</span><br><span class="line">.text:00000001400A20BB loc_1400A20BB:                          ; CODE XREF: KiSystemCall64+5A8↑j</span><br><span class="line">.text:00000001400A20BB                 btr     word ptr gs:2378h, 2</span><br><span class="line">.text:00000001400A20C6                 jnb     short loc_1400A20D6 ; rax=系统调用返回值</span><br><span class="line">.text:00000001400A20C8                 mov     eax, 1</span><br><span class="line">.text:00000001400A20CD                 xor     edx, edx</span><br><span class="line">.text:00000001400A20CF                 mov     ecx, 49h ; &#x27;I&#x27;</span><br><span class="line">.text:00000001400A20D4                 wrmsr</span><br><span class="line">.text:00000001400A20D6</span><br><span class="line">.text:00000001400A20D6 loc_1400A20D6:                          ; CODE XREF: KiSystemCall64+5C6↑j</span><br><span class="line">.text:00000001400A20D6                 mov     rax, [rbp-50h]  ; rax=系统调用返回值</span><br><span class="line">.text:00000001400A20DA                 mov     r8, [rbp+100h]  ; r8=r3的rsp</span><br><span class="line">.text:00000001400A20E1                 mov     r9, [rbp+0D8h]  ; r9=r3的rbp</span><br><span class="line">.text:00000001400A20E8                 xor     edx, edx</span><br><span class="line">.text:00000001400A20EA                 pxor    xmm0, xmm0</span><br><span class="line">.text:00000001400A20EE                 pxor    xmm1, xmm1</span><br><span class="line">.text:00000001400A20F2                 pxor    xmm2, xmm2</span><br><span class="line">.text:00000001400A20F6                 pxor    xmm3, xmm3</span><br><span class="line">.text:00000001400A20FA                 pxor    xmm4, xmm4</span><br><span class="line">.text:00000001400A20FE                 pxor    xmm5, xmm5</span><br><span class="line">.text:00000001400A2102                 mov     rcx, [rbp+0E8h] ; rcx=syscall的返回地址</span><br><span class="line">.text:00000001400A2109                 mov     r11, [rbp+0F8h] ; r11=eflags</span><br><span class="line">.text:00000001400A2110                 test    cs:KiKvaShadow, 1</span><br><span class="line">.text:00000001400A2117                 jnz     KiKernelSysretExit</span><br><span class="line">.text:00000001400A211D                 mov     rbp, r9         ; 恢复r3栈帧</span><br><span class="line">.text:00000001400A2120                 mov     rsp, r8</span><br><span class="line">.text:00000001400A2123                 swapgs                  ; 切换gs到teb</span><br><span class="line">.text:00000001400A2126                 sysret</span><br></pre></td></tr></table></figure>

  </div>
</article>



      </div>
      
       <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Syscall"><span class="toc-number">1.</span> <span class="toc-text">Syscall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KiSystemCall64Shadow"><span class="toc-number">2.</span> <span class="toc-text">KiSystemCall64Shadow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KiSystemServiceExit"><span class="toc-number">3.</span> <span class="toc-text">KiSystemServiceExit</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&text=系统调用"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&title=系统调用"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&is_video=false&description=系统调用"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=系统调用&body=Check out this article: http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&title=系统调用"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&title=系统调用"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&title=系统调用"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&title=系统调用"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://sh1xo.cn/2021/03/12/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/&name=系统调用&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

      
      <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2022 sh1xo
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

      
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->

<!-- Disqus Comments -->


    </div>
</body>
</html>
